#!/usr/bin/env bash
# pve-nut-shutdown  – called by NUT when FSD fires
set -euo pipefail

log() {
    logger -t NUT-SHUTDOWN -- "$@"
    printf '%s\n' "$*"
}

# 0. Make absolutely sure we only run once per node
if systemctl --quiet is-system-running | grep -q "stopping"; then
    exit 0
fi

NODE="$(hostname)"

log "UPS FSD received – disabling HA on ${NODE}"

# 1. Freeze the HA scheduler for this node (no migrations/fencing)
ha-manager crm-command node-maintenance enable "$NODE"

# 2. Stop the local HA daemons so nothing restarts behind us
systemctl stop pve-ha-crm pve-ha-lrm watchdog-mux

# 3. Give the CRM a few seconds to write its status
sleep 8

# 4. Gracefully shut down every guest that is still running here
qm list --noheader | awk '{print $1}' | while read -r vid; do
    qm shutdown "$vid" --timeout 60 >/dev/null 2>&1 || true
done
pct list --noheader | awk '{print $1}' | while read -r cid; do
    pct shutdown "$cid" --timeout 60 >/dev/null 2>&1 || true
done

# 5. Wait up to five minutes for guests to die cleanly
timeout=300; while pgrep -f '^(kvm|lxc-start)$' >/dev/null && [ $timeout -gt 0 ]; do
    sleep 5; timeout=$((timeout-5))
done

log "Guests stopped – powering off ${NODE}"
/sbin/shutdown -h now
